<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Chat Area</title>
    <style>
        body { font-family: sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; line-height: 1.6; }
        .status-box { padding: 20px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ddd; }
        .success { background: #e0f7fa; color: #006064; border-color: #b2ebf2; }
        .error { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
        code { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
        button { background: #555; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #333; }
    </style>

    <script>
        // --- CONFIGURATION ---
        const CONF = {
            // MUST match index.html exactly (including trailing slashes)
            redirect_uri: "https://tdurbin.github.io/auth/chat.html", 
            auth0_domain: "dev-0ds2lps500xulygz.uk.auth0.com",
            auth0_client_id: "etyzcqmFckYtsLOH3HhLieK6yRNy254z",
            lp_site_id: "81412129"
        };

        // --- 1. UTILITIES ---
        
        // Parse Hash parameters (Hybrid flow puts tokens in the hash #)
        function getAuthParams() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return {
                code: params.get('code'),
                id_token: params.get('id_token')
            };
        }

        // Decode JWT to read the 'sub' and 'iss'
        function decodeJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(c => 
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) { return null; }
        }

        // --- 2. LOGIC ---
        
        const credentials = getAuthParams();
        let userInfo = null;
        let codeHasBeenUsed = false; // FLAG: Prevent sending the same code twice

        // PRE-LOAD: Define LivePerson Identity (Targeting)
        // This MUST run before the main LP tag loads. Shows the button.
        window.lpTag = window.lpTag || {};
        window.lpTag.identities = [];
        window.lpTag.identities.push(function(callback) {
            if (credentials.id_token) {
                userInfo = decodeJwt(credentials.id_token);
                console.log("[Identity] User identified:", userInfo.sub);
                
                callback({
                    iss: userInfo.iss, // e.g. https://dev-....auth0.com/
                    acr: 'loa1',       // Mandatory for LP
                    sub: userInfo.sub  // The unique User ID
                });
            } else {
                console.warn("[Identity] No ID Token found. Chat button may be hidden.");
                callback(null);
            }
        });

        // RUNTIME: Define Authentication Handshake (Security)
        // This runs when the chat window attempts to connect (initially or on refresh)
        window.lpGetAuthenticationToken = function(callback) {
            console.log("[Auth] LivePerson requesting handshake...");
            
            // SCENARIO 1: First time connecting. We have a code and haven't used it.
            if (credentials.code && !codeHasBeenUsed) {
                console.log("[Auth] Sending Auth Code to LivePerson backend.");
                codeHasBeenUsed = true; // MARK AS USED to prevent 401 loop
                callback(credentials.code);                 
                //callback({
                //    ssoKey: credentials.code,
                //    redirect_uri: CONF.redirect_uri
                //});
            } 
            // SCENARIO 2: Re-connecting (e.g. minimize/maximize) but code is stale.
            else if (codeHasBeenUsed) {
                console.log("[Auth] Session refresh requested, but Auth Code was already used.");
                console.log("[Auth] Assuming backend has Refresh Token (offline_access). Sending null to stop loop.");
                callback(credentials.code); 
                // Passing null tells LP "I have nothing new to give you." 
                // If LP has a refresh token (offline_access), it will stay connected. 
                // If not, the user will need to log in again.
                //callback(null);
            }
            // SCENARIO 3: No code at all.
            else {
                console.error("[Auth] No Auth Code available.");
                callback(null);
            }
        };

    </script>

    <script type="text/javascript">window.lpTag=window.lpTag||{},'undefined'==typeof window.lpTag._tagCount?(window.lpTag={wl:lpTag.wl||null,scp:lpTag.scp||null,site:CONF.lp_site_id||'',section:lpTag.section||'',tagletSection:lpTag.tagletSection||null,autoStart:lpTag.autoStart!==!1,ovr:lpTag.ovr||{},_v:'1.10.0',_tagCount:1,protocol:'https:',events:{bind:function(t,e,i){lpTag.defer(function(){lpTag.events.bind(t,e,i)},0)},trigger:function(t,e,i){lpTag.defer(function(){lpTag.events.trigger(t,e,i)},1)}},defer:function(t,e){0===e?(this._defB=this._defB||[],this._defB.push(t)):1===e?(this._defT=this._defT||[],this._defT.push(t)):(this._defL=this._defL||[],this._defL.push(t))},load:function(t,e,i){var n=this;setTimeout(function(){n._load(t,e,i)},0)},_load:function(t,e,i){var n=t;t||(n=this.protocol+'//'+(this.ovr&&this.ovr.domain?this.ovr.domain:'lptag.liveperson.net')+'/tag/tag.js?site='+this.site);var o=document.createElement('script');o.setAttribute('charset',e?e:'UTF-8'),i&&o.setAttribute('id',i),o.setAttribute('src',n),document.getElementsByTagName('head').item(0).appendChild(o)},init:function(){this._timing=this._timing||{},this._timing.start=(new Date).getTime();var t=this;window.attachEvent?window.attachEvent('onload',function(){t._domReady('domReady')}):(window.addEventListener('DOMContentLoaded',function(){t._domReady('contReady')},!1),window.addEventListener('load',function(){t._domReady('domReady')},!1)),'undefined'===typeof window._lptStop&&this.load()},start:function(){this.autoStart=!0},_domReady:function(t){this.isDom||(this.isDom=!0,this.events.trigger('LPT','DOM_READY',{t:t})),this._timing[t]=(new Date).getTime()},vars:lpTag.vars||[],dbs:lpTag.dbs||[],ctn:lpTag.ctn||[],sdes:lpTag.sdes||[],hooks:lpTag.hooks||[],identities:lpTag.identities||[],ev:lpTag.ev||[]},lpTag.init()):window.lpTag._tagCount+=1;</script>

</head>
<body>

    <h1>Welcome to the Member Area</h1>
    
    <div id="status" class="status-box">Initializing...</div>
    <button onclick="logout()">Log Out</button>

    <script>
        // --- 4. UI FEEDBACK & CLEANUP ---
        const statusDiv = document.getElementById('status');

        if (credentials.code && credentials.id_token) {
            statusDiv.className = "status-box success";
            statusDiv.innerHTML = `
                <strong>Authentication Successful</strong><br><br>
                <span><strong>User ID (sub):</strong> ${userInfo ? userInfo.sub : 'Unknown'}</span><br>
                <span><strong>Auth Code:</strong> ${credentials.code.substring(0,15)}...</span><br><br>
                <em>The LivePerson chat button should appear shortly.</em>
            `;
            
            // SECURITY: Clear the address bar so the code/token aren't visible
            // NOTE: This prevents the user from refreshing the page and getting a 401 error
            window.history.replaceState({}, document.title, window.location.pathname);
            
        } else {
            statusDiv.className = "status-box error";
            statusDiv.innerHTML = `
                <strong>No Credentials Found</strong><br>
                Please return to the login page to authenticate.
            `;
        }

        function logout() {
            const returnTo = "https://tdurbin.github.io/auth/index.html";
            window.location.href = `https://${CONF.auth0_domain}/v2/logout?client_id=${CONF.auth0_client_id}&returnTo=${encodeURIComponent(returnTo)}`;
        }
    </script>
</body>
</html>