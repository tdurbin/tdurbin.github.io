!function($){function VA(){this.template;var init=!0;this.firstRequest=!0,this.rn=0,this.preventAjax=!1,that=this,this.initEventRan=!1,this.faqLoadTime=VAMD.conf.candidateCollectionCompute?new Date:0,this.faqClickTime=VAMD.conf.candidateCollectionCompute?new Date:0,this.lcTranscript=[];var defaults={isCookieEnabled:1};$.extend(defaults,VAMD.conf.va);for(var match,search=/([^&=]+)=?([^&]*)/g,decode=function(s){return decodeURIComponent(s.replace(/\+/g," "))};match=search.exec(window.location.search.substring(1));)defaults[decode(match[1])]=decode(match[2]);this.request=function(params){if($.extend(defaults,VAMD.conf.va),!VAMD.conf.state.enabled)return!1;if(that.preventAjax)return!1;that.preventAjax=!0,that.firstRequest&&"undefined"!=typeof vaStartupData&&$.extend(defaults,vaStartupData),that.firstRequest&&void 0!==params.businessArea&&(defaults.businessArea=params.businessArea),that.firstRequest&&void 0!==params.Channel&&(defaults.Channel=params.Channel),VAMD.conf.mobChannel.enable&&(VAMD.useMobChannel($)?defaults.Channel=VAMD.conf.mobChannel.name:defaults.Channel=VAMD.conf.va.Channel);var requestParams=$.extend({},defaults);"object"==typeof params&&$.extend(requestParams,params),init?init=!1:1==requestParams.FAQ&&delete requestParams.entry,$va=$(this),$va.trigger("va.request",[requestParams]);var noCache=["entry","startcontext"];for(keyname in requestParams)-1!==$.inArray(keyname,noCache)&&delete requestParams.init;var questionString="",jqxhr;if("FAQRequest"in requestParams&&""!=requestParams.FAQRequest&&(questionString=requestParams.FAQRequest),"entry"in requestParams&&""!=requestParams.entry&&(questionString=requestParams.entry.replace(/(<([^>]+)>)/gi,"")),"DTreeRequest"in requestParams&&""!=requestParams.DTreeRequest&&(questionString=requestParams.DTreeRequest),questionString.length>0){var $content=$("#virtual-assistant .va-content"),$question=$("<div/>",{class:"va-qst-node"}).append($("<div/>",{class:"va-qst"}));$question.find(".va-qst").append(questionString),$content.append($question),setTimeout((function(){$content.find(".va-qst-node:last").addClass("va-is-active"),va.scroll("bottom")}),0)}return va.loader(!0),VAMD.conf.debug&&console.group("[VA-INFO] Engine request"),VAMD.conf.debug&&console.log("[VA-INFO] Sending engine request. Request data: %o",requestParams),VAMD.conf.debug&&console.groupEnd(),new Date,$.extend(requestParams,{timestamp:Date.now()}),$.ajax({url:VAMD.conf.vaurl,dataType:"jsonp",data:requestParams,jsonpCallback:"cvcallback",cache:!1,timeout:2e4}).done((function(resp){that.preventAjax=!1,VAMD.conf.state.loaded=!0,VAMD.conf.state.typing=!1,$.extend(defaults,{ident:resp.ident,userlogid:resp.userlogid}),$va.ident=defaults.ident,VAMD.conf.state.ident=defaults.ident,$va.userlogid=defaults.userlogid,$va.trigger("va.response",[resp,this]),that.firstRequest=!1})).fail((function(jqXHR,exception){VAMD.util.ajaxErrorParse(jqXHR,exception),that.preventAjax=!1;var $content=$("#virtual-assistant .va-content"),$answer=$("<div/>",{class:"va-ans-node"}).append($("<div/>",{class:"va-ans"}).append("An error has occurred. Please try asking your question again or simply reload the page."));$content.append($answer),setTimeout((function(){$content.find(".va-ans-node:last").addClass("va-is-active")}),0),va.loader(!1)}))}}VA.prototype.init=function(params){this.initEventRan||($(this).trigger("va.init"),this.initEventRan=!0);var requestParams={};return"object"==typeof params&&$.extend(requestParams,params),this.request(requestParams)},VA.prototype.terminate=function(){return this.request({sessionclosed:1})},VA.prototype.ask=function(question){return this.request({entry:question})},VA.prototype.disambiguationPromptClick=function(ansNo,display){return this.request({entry:display,DisambiguationOption:ansNo})},VA.prototype.loadTemplate=function(){$(".virtual-assistant-wrapper").html($(this.template).html())},VA.prototype.makeBreadcrumb=function(category){var $breadcrumb=$("<div/>");$breadcrumb.html("");var cats=category.split(".");return $(cats).slice(0,-1).each((function(i,item){$("<a/>",{href:"javascript:void(0)","data-category":cats.slice(0,i+1).join(".")}).text(item.replace("Root","FAQ")).appendTo($breadcrumb)})),$(cats).slice(-1).each((function(i,item){$("<span/>").text(item).appendTo($breadcrumb)})),$breadcrumb.html()},VA.prototype.makeFAQ=function(resp){var $faqList=$("<ul/>"),i=0;return $.each(resp.questions,(function(index,node){var $listItem=$("<li/>");VAMD.conf.candidateCollectionCompute?$listItem.append($("<a/>",{href:"javascript:void(0)","data-recognition-id":node.recognition_id,"data-dtree":node.data_dtree||"false","data-answer-id":node.answer_id,"data-counter":node.faqcounter||index+1,"data-subtype":node.subtype}).append(node.faqdisplay)):$listItem.append($("<a/>",{href:"javascript:void(0)","data-recognition-id":node.recognition_id,"data-dtree":node.data_dtree||"false","data-answer-id":node.answer_id}).append(node.faqdisplay)),$faqList.append($listItem)})),$faqList.clone().wrap("<p>").parent().html()},VA.prototype.makeSemFaqs=function(resp){var $semFaqs=$(resp).find("semanticfaq"),$list=$("<div/>",{class:"dtree va-faq-ul va-dtree clearfix"}),i=0;return $semFaqs.each((function(i,item){if(5==i)return!1;$list.append($("<a/>",{href:"javascript:void(0)",tabindex:"1","data-answer-id":$(item).find("AnswerId").text(),"data-dtree":"false","data-recognition-id":$(item).find("RecognitionId").text()}).append($(item).find("QuestionText").text())),i++})),$list.clone().wrap("<p>").parent().html()},VA.prototype.makeDropdown=function(resp){var $dropdown=$("<select/>",{name:"Navcontext",tabindex:0}),$option=$("<option/>");return $dropdown.append($("<option/>",{value:""}).append("Select category")),$.each(resp.dropdown,(function(index,node){var $option=$("<option/>",{value:node.displaycontext});$option.append(node.displaycontext),$dropdown.append($option)})),$dropdown.clone().wrap("<p>").parent().html()},VA.prototype.makeDTree=function(resp){var dTreeStyle=resp.dtreestyle,dTreeBackNav=resp.backnavflag,dTreeBackSuppress=resp.dtreeback,dtreeConnFreeText=resp.freetextcon.split(";"),connectors=resp.connectors.Connectors,$dtree=$("<div/>",{class:"va-ans-opt"}),imageList=!1;switch(dTreeStyle){case"ol":$dTreeList=$("<ol/>");break;case"ul":$dTreeList=$("<ul/>");break;default:$dTreeList=$("<div/>")}for(var i in $dTreeList.addClass("dtree va-dtree"),connectors)if(void 0!==connectors[i].DefaultClickText&&""!=connectors[i].DefaultClickText){var connId=connectors[i].ConnectorID,connText=connectors[i].DefaultClickText,connImage=connectors[i].image,$a=$("<a/>",{href:"javascript:void(0)",class:"va-dtree-opt","data-connector-id":connId,"data-freetext":$.inArray(connText,dtreeConnFreeText)}).text(connText);$dTreeList.is("ul,ol")?$dTreeList.append($("<li/>").append($a)):$dTreeList.append($a)}if($dtree.append($dTreeList),"1"==dTreeBackNav&&!dTreeBackSuppress){var $a=$("<a/>",{class:"dtree-back va-dtree-back",href:"javascript:void(0)"}).append("Go back");$dTreeList.is("ul,ol")?$dTreeList.append($("<li/>").append($a)):$dTreeList.append($a)}return $dtree.append($dTreeList),$dtree.html()},VA.prototype.triggerICS=function(icsCommand,resp){var ics=window.vaics||null,reICS;if(/^whyNotSaveCall|whyNotHelpful$/.test(icsCommand)){var otherReason=resp.otherreason,otherReasonText="Specify your own reason";""!=resp.otherreasontext&&(otherReasonText=resp.otherReasonText),VAMD.ics.create($,icsCommand,resp.connectors.Connectors,otherReason,otherReasonText)}},VA.prototype.loader=function(show){show?$("#virtual-assistant .va-loading").css({display:"block"}):$("#virtual-assistant .va-loading").hide()},VA.prototype.setUserReminder=function(){var $content=$("#virtual-assistant .va-content"),$answer=$("<div/>",{class:"va-ans-node"}).append($("<div/>",{class:"va-ans"}));$answer.find(".va-ans").append("How can we help you today? Please type your question below."),$content.append($answer),setTimeout((function(){$content.scrollTop(9999),$content.find(".va-ans-node:last").addClass("va-is-active")}),0)},VA.prototype.retryRequest=function(params){return this.request(params)},VA.prototype.ask_question=function(question,faqIDin,faqMainCatID,faqMainCatDesc,recognitionID,answerID){var params={FAQ:"1",FAQRequest:question,mainCat:faqMainCatID||va.mainCat};return 6==arguments.length&&$.extend(params,{ANSWER_ID:recognitionID,RECOGNITION_ID:answerID}),this.request(params)},VA.prototype.scroll=function(dir){if($(window).width()>=VAMD.conf.threshold)switch($sc=$("#virtual-assistant .va-content"),dir){case"top":$sc.scrollTop(0);break;case"bottom":$sc.scrollTop(99999)}else switch(dir){case"top":$(window).scrollTop(0);break;case"bottom":$(window).scrollTop(1e4)}},VA.prototype.nav=function(url,param){var win;window.open(url,"_blank").focus()},window.va=new VA,$(va).on("va.init",(function(event){va.$wrapper=$("#virtual-assistant"),va.$wrapper.on("click",".va-inp-btn",(function(event){if(VAMD.conf.state.enabled){var question=$.trim($(".va-inp-txt").val());event.preventDefault(),question.length>0&&va.request({entry:question,mainCat:va.mainCat}),$(".va-autocomplete").removeClass("va-show")}})),va.$wrapper.on("keypress",".va-inp-txt",(function(event){if(13==event.which)return $(".va-inp-btn").trigger("click"),!1})),va.$wrapper.on("click",".va-autocomplete a",(function(e){var $a=$(e.target);e.preventDefault(),va.request({type:"SELECT",selectSource:"autocomplete",ANSWERLINK_ID:$a.attr("data-answer-id"),RECOGNITION_ID:$a.attr("data-recognition-id"),entry:$a.text()}),$(".va-inp-txt").val($(this).text()),VAMD.conf.autocomplete&&VAMD.autocomplete.destroy($)})),va.$wrapper.on("click",".va-faqs a, .va-faq-ul a",(function(e){e.preventDefault();var $a=$(e.target);if("True"==$a.attr("data-dtree"))va.request({entry:$a.text().replace("."," "),mainCat:va.mainCat});else if(VAMD.conf.candidateCollectionCompute){that.faqClickTime=new Date;var differenceClick=that.faqClickTime.getTime()-that.faqLoadTime.getTime(),seconds=Math.floor(differenceClick/1e3);va.request({FAQ:1,ANSWER_ID:$a.attr("data-answer-id"),RECOGNITION_ID:$a.attr("data-recognition-id"),subtype:$a.attr("data-subtype"),FAQRequest:$a.text(),ClickTime:seconds,Position:$a.attr("data-counter")})}else va.request({FAQ:1,ANSWER_ID:$a.attr("data-answer-id"),RECOGNITION_ID:$a.attr("data-recognition-id"),FAQRequest:$a.text()});!$(this).parent().parent().hasClass("va-faq-ul")&&$(".va-related-head.va-toggle").trigger("click"),VAMD.conf.autocomplete&&VAMD.autocomplete.destroy($)})),va.$wrapper.on("click",".va-deep-faq",(function(event){var $a=$(event.target);event.preventDefault(),va.request({type:"SELECT",selectSource:"DM",collect:"true",RECOGNITION_ID:$a.attr("data-recid"),entry:$a.text().replace("."," "),mainCat:va.mainCat})})),va.$wrapper.on("click",".va-breadcrumbs li > a:not(:last), .va-breadcrumbs > a",(function(event){var $a=$(event.target);event.preventDefault(),va.request({FAQ:1,ButtonRequest:"change_Context",navcontext:$a.attr("data-category"),mainCat:va.mainCat})})),va.$wrapper.on("change",".va-dropdown select",(function(event){$opt=$(event.target),va.request({FAQ:1,ButtonRequest:"change_Context",navcontext:[va.mainCat,$opt.val()].join("."),mainCat:va.mainCat})})),va.$wrapper.on("click",".va-ans-node:last .va-ans .dtree-back",(function(event){var $a=$(event.target);event.preventDefault(),va.request({DTreeRequestType:3,connector_ID:$a.attr("data-connector-id"),DTreeRequest:$a.text(),DTREE_OBJECT_ID:va.dTreeObjectId,DTREE_NODE_ID:va.dTreeNodeId,ICS_SOURCE_ANSWER_ID:va.icsSourceAnswerId})})).on("click",".va-ans-node:last .va-ans .dtree a",(function(event){$(".dtree:last a").on("click",(function(){return!1}));var $a=$(event.target);event.preventDefault(),$a.attr("data-freetext")>=0?va.request({entry:$a.text()}):va.request({DTreeRequestType:2,connector_ID:$a.attr("data-connector-id"),DTreeRequest:$a.text(),DTREE_OBJECT_ID:va.dTreeObjectId,DTREE_NODE_ID:va.dTreeNodeId,ICS_SOURCE_ANSWER_ID:va.icsSourceAnswerId})})),va.$wrapper.on("click",".va-gotop",(function(){va.scroll("top")})),va.$wrapper.on("click",".va-deep-faq a",(function(e){e.preventDefault();var $a=$(e.target);va.request({entry:$a.text().replace("."," "),mainCat:va.mainCat}),va.loader(!1)}))})),$(va).on("va.response",(function(event,resp,req){VAMD.conf.debug&&console.group("[VA-INFO] Engine response"),VAMD.conf.debug&&console.log("[VA-INFO] Parsing engine response. Response data: %o",resp),VAMD.conf.debug&&console.groupEnd();var $breadcrumbs=$("#virtual-assistant .va-breadcrumbs"),$content=$("#virtual-assistant .va-content"),$input=$("#virtual-assistant .va-inp-txt"),$faqs=$("#virtual-assistant .va-faqs"),showQuestion=!("LIVECHATSTART"==resp.question||"LIVECHATEND"==resp.question||"change_Context"==resp.question&&va.firstRequest),$freetextdisable=$(resp).find("freetextdisable").text(),isNavRequest=/ButtonRequest=change_Context/i.test(req.url);if(VAMD.conf.autonav&&resp.autonav.href.length>0&&!va.firstRequest&&window.open(resp.autonav.href,"_self"),va.firstRequest&&VAMD.conf.history&&""==VAMD.util.getStorage("VA_HISTORY")&&$("#virtual-assistant .va-content").prepend($("<div/>",{class:"va-session-start"}).append(VAMD.util.sessionStartDate())),va.firstRequest||1==resp.safetynet?$("#virtual-assistant .va-subheading, #virtual-assistant .va-related-head").html("Frequently asked questions"):$("#virtual-assistant .va-subheading, #virtual-assistant .va-related-head").html("Related questions"),VAMD.conf.history&&va.firstRequest){VAMD.util.getStorage("VA_SESSIONTIME")&&VAMD.util.getTimeoutOffset()>9&&(VAMD.conf.debug&&console.log("[VA-INFO] %cSession timeout reached, clearing history","color:#999999"),VAMD.util.clearStorage("VA_SESSIONTIME"),VAMD.util.clearStorage("VA_HISTORY")),VAMD.util.setStorage({VA_SESSIONTIME:Date.now()});var vaHistory=VAMD.util.getStorage("VA_HISTORY")}if(""!=resp.dtreequestion&&(resp.question=resp.dtreequestion),$(va).trigger("va.category.changed",[resp.maincat]),va.mainCat=resp.maincat,va.dTreeObjectId=resp.dtreeobjectid,va.dTreeNodeId=resp.dtreenodeid,va.icsSourceAnswerId=resp.answerID,$faqs.html(va.makeFAQ(resp)),VAMD.conf.candidateCollectionCompute&&(that.faqLoadTime=new Date),$breadcrumbs.html(va.makeBreadcrumb(resp.maincat)),"Root"==va.mainCat?$breadcrumbs.hide():$breadcrumbs.show(),0!=resp.dropdown.length?$(".va-dropdown").show().html(va.makeDropdown(resp)):$(".va-dropdown").hide().html(va.makeDropdown(resp)),"_ics_user_cancelled_"==resp.question&&(resp.question="ICS closed"),"_ics_no_reason_given_"==resp.question&&(resp.question="No reason was given"),isNavRequest)resp.question=va.question,resp.answer=va.answer;else if(VAMD.conf.history&&va.firstRequest&&0!=vaHistory)$content.append(vaHistory).scrollTop(9999);else if(VAMD.conf.convScroll){var $answer=$("<div/>",{class:"va-ans-node"}).append($("<div/>",{class:"va-ans"}));$answer.find(".va-ans").append(resp.answer+va.makeDTree(resp)),$content.append($answer),setTimeout((function(){$content.find(".va-ans-node:last").addClass("va-is-active"),VAMD.conf.history&&VAMD.util.setStorage({VA_HISTORY:$(".va-content").html()})}),0)}va.triggerICS(resp.showicsoverlay,resp),va.question=resp.question,va.answer=resp.answer,$input.val(""),$(window).width()>VAMD.conf.threshold?$input.focus():$input.blur(),showQuestion&&resp.question.length>0&&"change_Context"!=resp.question&&$content.scrollTop($content.scrollTop()-$content.offset().top+$(".va-qst-node:last").offset().top-10),va.rn++,va.loader(!1),va.firstRequest||"Root.Dtrees.ICS"==resp.category||(6==va.lcTranscript.length&&va.lcTranscript.splice(0,2),va.lcTranscript.push("visitor: "+resp.question),va.lcTranscript.push("VA: "+resp.answer))}))}(cvjq);